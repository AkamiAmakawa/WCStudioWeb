<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News</title>
    <link rel="stylesheet" href="/css/news.css">
    <link rel="stylesheet" href="/fonts/themify-icons/themify-icons.css">
    <link rel='stylesheet' href="/ckeditor/contents.css">
</head>
<body>
    <div id="main">
      <div id="header">
        <%- include("./partials/navbar.ejs")%>
      </div>

      
    </div>

<!-- edit/delete button     -->
<%  hidden = "";
 if (!user || (data.authorId != user.id && user.userInfo.permissionLevel < 3)) { 
    hidden = "d-none";
 } %>

        <div id="content">
            <article>
              <h1 class="titledetail">
                <%= data.a_name %>
              </h1>

              <div class="userdetail">
                <a href="/user/<%=data.UserAccount.username %>"><%= data.UserAccount.userInfo.displayName%></a>

                <span>
                  <%= data.createdAt %>
                </span>
              </div>
              <p><%- data.content %></p>
            </article>
        </div>

        <div class="btn-group dropup <%= hidden %>">
          <button class="btn btn-secondary dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Setting
          </button>
          <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
            <a href="/edit_article/<%= data.id%>"><button class = "dropdown-item">Edit</button></a>
            <button onclick="delConfirm()" class = "dropdown-item">Remove</button>
          </div>
        </div>

        <div class="container-fluid">
          <h3>Comment section</h3>
          <ul class="list-group" id="posted-comment">

            <% let j = 0;
             commentList.forEach(comment => {
             %>
              <div class="text-justify darker mt-4 float-right row" id="cmt">
                      <img src="https://i.imgur.com/CFpa3nK.jpg" alt="" class="rounded-circle" width="40" height="40" style="margin-left: 16px;">
                      <div class="col-3.5"><a href="/user/<%=comment.UserAccount.username%>">
                        <%= comment.UserAccount.userInfo.displayName %>

                        <a> <span>- <%= comment.createdAt%></span> <br></div>
                      <div id="cmt-content" class="col-8"><p style="text-align: left;"><%=comment.content%></p></div>


                      <%  if (user && (comment.authorId == user.id || user.userInfo.permissionLevel > 2)) {  %>
                      <div class="col-10 mr-auto">
                        <a href="#" onclick="return editCmtFunc(<%= j %>)" id="edit-cmt">Edit</a>
                        <a href="#" onclick="return deleteCmtFunc(<%= j %>)">Delete</a>
                      </div>
                      <% } %>
                  </div>
            <% j++; }); %>
            </ul>

               <!--PAGINATION -->
               
               <nav aria-label="Comment page navigation">
            <ul class = "pagination justify-content-end">
                <%
                var prev_state = "";
                var next_state = "";
                if (parseInt(pag.current) == 1) {
                        var prev_state = "disabled";
                }
                    if (parseInt(pag.current) == pag.total){
                        var next_state = "disabled";
                    }
                 %>

                <li class="page-item <%= prev_state %>">
                    <a class="page-link" href="/a/<%= data.id %>/<%= parseInt(pag.current)-1 %>" aria-label="Previous">
                      <span aria-hidden="true">&laquo;</span>
                       <span class="sr-only">Previous</span>
                      </a>
                </li>

                <% for (var i = pag.current - pag.max_show_page; i < pag.current; i++){ 
                    if (i > 0){ %>
                        <li class="page-item"><a class="page-link" href="/a/<%= data.id %>/<%= i %>"><%= i %></a></li>
                <%   }
                 } %>
                 
                <li class="page-item active">
      <a class="page-link" href="/a/<%= data.id %>/<%= pag.current %>">  <%= pag.current %> <span class="sr-only">(current)</span></a>
                </li>
                
                <% for (var i = parseInt(pag.current) + 1; i <= (pag.current + pag.max_show_page); i++){
                    if (i <= pag.total){ %>
                        <li class="page-item"><a class="page-link" href="/a/<%= data.id %>/<%= i %>"><%= i %></a></li>
                <%    } 
                 } %>

                <li class="page-item <%= next_state %>">
                    <a class="page-link" href="/a/<%= data.id %>/<%= parseInt(pag.current) + 1 %>" aria-label="Next">
                      <span aria-hidden="true">&raquo;</span>
                       <span class="sr-only">Next</span>
                      </a>
                </li>
            </ul>
        </nav>
        </div>




          <% if (user){ %>
          <div class="form-group">
            <form action="/a/<%= data.id %>" method="POST">
              <img src="https://i.imgur.com/CFpa3nK.jpg" alt="" class="rounded-circle" width="40" height="40">
            <input type="hidden" name = "articleId" id="articleId" value="<%= data.id%>">    
            <input type="hidden" name = "authorId" id="authorId" value="<%= user.id%>">   
            <input type="hidden" name = "edit" id = "edit">
            <input type="text" class="form-control" name="comment" id="comment" placeholder="Say something!" style="width: 96%; float: right;">
          </div>
          <button type="submit" class="btn btn-outline-primary" id="submit-button" style="margin-left: 60px;">Submit</button>
        </form>
        <%} %>

                
        <!-- <% commentList.forEach(comment => { %>
            <div class="text-justify darker mt-4 float-right" id="cmt"> <img src="https://i.imgur.com/CFpa3nK.jpg" alt="" class="rounded-circle" width="40" height="40">
                    <a href="/user/<%=comment.UserAccount.username%>">
                      <%= comment.UserAccount.userInfo.displayName %>
                      <a> <span>- <%= comment.createdAt%></span> <br>
                    <p><%=comment.content%></p>
                </div>
          <%}); %> -->
          </ul>
        </div>

        
        <!-- Script -->
<script>
  var cmts = <%- JSON.stringify(commentList) %>
  function delConfirm() {
  if(confirm("Do you want to delete this article?")){
    document.location.href = "/remove_article/<%= data.id %>";
  }
}
  function editCmtFunc(id) {
    document.getElementById("comment").value = cmts[id].content;
    document.getElementById("edit").value = cmts[id].id;
    return false;
  }
  function deleteCmtFunc(id) {
    if(confirm("Do you want to delete this comment?")){
    document.location.href = "/remove_cmt/<%= data.id %>/" + cmts[id].id;    
  }
  return false;
}
</script>

<!-- Footer -->
        <%- include("./partials/footer.ejs")%>;
<!-- Footer -->
    </div>
</body>
</html>